@{
    ViewData["Title"] = "Logs Viewer";
}

<div id="app">
    <header class="mb-10">
        <h1 class="text-4xl md:text-5xl font-semibold text-white mt-2">Logs Viewer</h1>
        <p class="text-slate-300 mt-4 max-w-2xl">
            Browse server log files, filter by filename, and inspect live content without leaving the browser.
        </p>
    </header>

        <section class="grid gap-6 lg:grid-cols-[320px_minmax(0,1fr)]">
            <aside class="bg-slate-900/70 border border-slate-700/60 rounded-2xl p-5 shadow-lg">
                <div class="flex items-center justify-between gap-2">
                    <h2 class="text-lg font-semibold text-white">Log Files</h2>
                    <div class="flex items-center gap-2">
                        <button class="text-xs uppercase tracking-wide text-slate-400 hover:text-slate-200 md:hidden" @@click="listOpen = !listOpen">
                            {{ listOpen ? "Hide" : "Show" }}
                        </button>
                        <button class="text-xs uppercase tracking-wide text-slate-400 hover:text-slate-200" @@click="refreshLogs">
                            Refresh
                        </button>
                    </div>
                </div>
                <div class="mt-4 space-y-3" v-show="listOpen">
                    <input v-model="listFilter" placeholder="Filter files..." class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm" />
                    <div v-if="loading" class="text-sm text-slate-400">
                        Loading logs...
                    </div>
                    <div v-else-if="filteredLogs.length === 0" class="text-sm text-slate-400">
                        No log files found.
                    </div>
                    <ul v-else class="space-y-2 max-h-[40vh] md:max-h-[420px] overflow-auto pr-2">
                        <li v-for="log in filteredLogs" :key="log.name">
                            <button class="w-full text-left rounded-xl border px-3 py-2 transition"
                                    :class="log.name === selectedLog?.name ? 'border-indigo-400/80 bg-indigo-500/20 text-indigo-100' : 'border-slate-700/60 bg-slate-950/40 text-slate-200 hover:bg-slate-800/40'"
                                    @@click="selectLog(log)">
                                <div class="text-sm font-medium truncate">{{ log.name }}</div>
                                <div class="text-xs text-slate-400 mt-1 flex justify-between gap-2">
                                    <span>{{ formatTimestamp(log.lastWriteTime) }}</span>
                                    <span>{{ formatSize(log.sizeBytes) }}</span>
                                </div>
                            </button>
                        </li>
                    </ul>
                </div>
            </aside>

            <div class="bg-slate-900/70 border border-slate-700/60 rounded-2xl p-6 shadow-lg">
                <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-white">Log Content</h2>
                        <p class="text-xs text-slate-400 mt-1" v-if="selectedLog">
                            {{ selectedLog.name }} Â· {{ formatTimestamp(selectedLog.lastWriteTime) }}
                        </p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button class="px-4 py-2 rounded-lg border border-slate-700 text-slate-200 text-sm hover:bg-slate-800/50 transition md:hidden" @@click="listOpen = true">
                            Open list
                        </button>
                        <input v-model="contentFilter" placeholder="Filter lines..." class="bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm" />
                        <button class="px-4 py-2 rounded-lg bg-indigo-500 text-white text-sm font-semibold hover:bg-indigo-400 transition" @@click="reloadSelected">
                            Reload
                        </button>
                    </div>
                </div>

                <div class="mt-4">
                    <div v-if="loadingContent" class="text-sm text-slate-400">
                        Loading content...
                    </div>
                    <div v-else-if="!selectedLog" class="text-sm text-slate-400">
                        Select a log file from the list.
                    </div>
                    <div v-else class="space-y-3">
                        <div class="text-xs text-slate-400">
                            Showing {{ filteredLineCount }} lines
                        </div>
                        <pre class="bg-slate-950/80 border border-slate-800 rounded-2xl p-4 text-xs text-slate-200 overflow-auto max-h-[60vh] md:max-h-[520px] whitespace-pre-wrap">{{ filteredContent }}</pre>
                    </div>
                </div>
            </div>
        </section>
    </div>

@section Scripts {
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    listOpen: true,
                    logs: [],
                    listFilter: "",
                    selectedLog: null,
                    content: "",
                    contentFilter: "",
                    loading: false,
                    loadingContent: false
                };
            },
            computed: {
                filteredLogs() {
                    if (!this.listFilter) {
                        return this.logs;
                    }
                    const filter = this.listFilter.toLowerCase();
                    return this.logs.filter(log => log.name.toLowerCase().includes(filter));
                },
                filteredContent() {
                    if (!this.contentFilter) {
                        return this.content;
                    }
                    const filter = this.contentFilter.toLowerCase();
                    const lines = this.content.split("\n");
                    return lines.filter(line => line.toLowerCase().includes(filter)).join("\n");
                },
                filteredLineCount() {
                    if (!this.filteredContent) {
                        return 0;
                    }
                    return this.filteredContent.split("\n").length;
                }
            },
            mounted() {
                this.refreshLogs();
            },
            methods: {
                async refreshLogs() {
                    this.loading = true;
                    try {
                        const response = await fetch("/api/logs");
                        const data = await response.json();
                        this.logs = Array.isArray(data) ? data : [];
                        if (this.logs.length > 0) {
                            this.selectLog(this.logs[0]);
                        } else {
                            this.selectedLog = null;
                            this.content = "";
                        }
                    } catch (error) {
                        this.logs = [];
                        this.selectedLog = null;
                        this.content = `Failed to load logs: ${error}`;
                    } finally {
                        this.loading = false;
                    }
                },
                async selectLog(log) {
                    this.selectedLog = log;
                    await this.loadContent(log.name);
                },
                async reloadSelected() {
                    if (!this.selectedLog) {
                        return;
                    }
                    await this.loadContent(this.selectedLog.name);
                },
                async loadContent(name) {
                    this.loadingContent = true;
                    try {
                        const response = await fetch(`/api/logs/${encodeURIComponent(name)}`);
                        if (!response.ok) {
                            this.content = `Failed to load file (${response.status}).`;
                            return;
                        }
                        this.content = await response.text();
                    } catch (error) {
                        this.content = `Failed to load file: ${error}`;
                    } finally {
                        this.loadingContent = false;
                    }
                },
                formatTimestamp(value) {
                    if (!value) {
                        return "";
                    }
                    const date = new Date(value);
                    if (Number.isNaN(date.getTime())) {
                        return value;
                    }
                    return date.toLocaleString();
                },
                formatSize(value) {
                    const size = Number(value || 0);
                    if (size < 1024) {
                        return `${size} B`;
                    }
                    if (size < 1024 * 1024) {
                        return `${(size / 1024).toFixed(1)} KB`;
                    }
                    return `${(size / (1024 * 1024)).toFixed(1)} MB`;
                }
            }
        }).mount("#app");
    </script>
}
